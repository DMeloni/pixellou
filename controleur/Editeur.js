
var ENTITE_HEROS = "3";
var ENTITE_TROLL = "5";
var ENTITE_PRINCESSE = "2";
var ENTITE_MUR = "1";
var ENTITE_LAVE = "4";
var ENTITE_VIDE = "0";



var width =  1024,//document.documentElement.clientWidth - document.documentElement.clientWidth % DIM_BLOC - DIM_BLOC, 
	height = 640,//document.documentElement.clientHeight - document.documentElement.clientHeight % DIM_BLOC - DIM_BLOC,
	c = document.getElementById('c'), 
	ctx = c.getContext('2d');			
	c.width = width;
	c.height = height;
//var map_modifiee = [["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1"],["1","0","3","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","2","0","1"],["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"]];


// Convertie un numéro d'entite en couleur
var convertieEntiteEnCouleur = function(entite){
	if(entite == ENTITE_MUR){
		return  ENTITE_COULEUR_MUR;
	}
	if(entite == ENTITE_LAVE){
		return  ENTITE_COULEUR_LAVE;
	}	
	if(entite == ENTITE_PRINCESSE){
		return  ENTITE_COULEUR_PRINCESSE;
	}				
	if(entite == ENTITE_HEROS){
		return  ENTITE_COULEUR_HEROS;
	}		
	if(entite == ENTITE_TROLL){
		return ENTITE_COULEUR_TROLL;
	}
	if(entite == ENTITE_VIDE){
		return ENTITE_COULEUR_VIDE;
	}	
	return ENTITE_COULEUR_VIDE;
}
// Convertie une couleur en entite
var convertieCouleurEnEntite = function(couleur){
	if(couleur == ENTITE_COULEUR_MUR){
		return  ENTITE_MUR;
	}
	if(couleur == ENTITE_COULEUR_LAVE){
		return  ENTITE_LAVE;
	}	
	if(couleur == ENTITE_COULEUR_PRINCESSE){
		return  ENTITE_PRINCESSE;
	}				
	if(couleur == ENTITE_COULEUR_HEROS){
		return  ENTITE_HEROS;
	}		
	if(couleur == ENTITE_COULEUR_TROLL){
		return ENTITE_TROLL;
	}
	if(couleur == ENTITE_COULEUR_VIDE){
		return ENTITE_VIDE;
	}	
	return ENTITE_VIDE;
}
// Une Map est un ensemble de case
var Map = function(){
	var that = this;
	that.representation = [];
	that.initialize = function (map_modifiee){
		for (var j = 0; j < map_modifiee.length ; j++) {
			for (var i = 0; i < map_modifiee[j].length ; i++) {		
				if(typeof(that.representation[i]) == "undefined"){
					that.representation[i] = [];
				}			
				that.representation[i][j] = new Case(convertieEntiteEnCouleur(map_modifiee[j][i]));
			}
		}
	}

	//that.representation = [];
	that.representationTexte = "";
	that.setCouleur = function(xMap, yMap, couleur){
		if(typeof(that.representation[xMap]) == 'undefined'){
			that.representation[xMap] = [];
		}		
		if(typeof(that.representation[xMap][yMap]) == 'undefined'){
			that.representation[xMap][yMap] = new Case(couleur);
		}else{
			if(that.representation[xMap][yMap].couleur != couleur){
				that.representation[xMap][yMap].setCouleur(couleur);						
				if(couleur == ENTITE_COULEUR_TROLL){
					mechants[nombreMechants] = new Troll(xMap, yMap);	
					mechants[nombreMechants].numeroMechant = nombreMechants;
					nombreMechants++;
				}
			
			
				if(couleur == ENTITE_COULEUR_MUR){
					map_modifiee[yMap][xMap] = ENTITE_MUR;
					murs[murs.length] = new Mur(xMap, yMap, 0);
					//i++;
				}
				if(couleur == ENTITE_COULEUR_VIDE){
					map_modifiee[yMap][xMap] = ENTITE_VIDE;
					murs.forEach(function(mur, index){
						if(mur.simpleX == xMap && mur.simpleY == yMap){
							delete murs[index];
						}
					});				
				}									
				nbBlocsRestants --;		
			}
		}
	}
	
	that.getCouleur = function(xMap, yMap){
		if(typeof(that.representation[xMap]) != 'undefined' && typeof(that.representation[xMap][yMap]) != 'undefined'){
			return that.representation[xMap][yMap].couleur;
		}
		return null;
	}
	
	that.convertieEnFichierTxt = function(){
		that.representationTexte = "";
		for(var j = 0 ; j < height / 16 ; j++){
			for(var i = 0 ; i < width/16 ; i++){
				if(typeof(that.representation[i]) != 'undefined'
				&& typeof(that.representation[i][j]) != 'undefined'
				){
					that.representationTexte += that.representation[i][j].getElement();
				}else{
					that.representationTexte += ENTITE_VIDE;
				}				
			}
			that.representationTexte += "\r\n";
		}
		return that.representationTexte;
	}
		
	
	return that;
}


// Une Case est une couleur
var Case = function(couleur){
	var that = this;
	that.couleur = couleur;	
	that.setCouleur = function(couleur){
		that.couleur = couleur;
	}
	that.draw = function(xMap, yMap){
		ctx.fillStyle = that.couleur ;
		ctx.fillRect(xMap * DIM_BLOC, yMap * DIM_BLOC, DIM_BLOC, DIM_BLOC);
	};
	
	that.getElement = function(){
		return convertieCouleurEnEntite(that.couleur);
	}
	
	return that;
}

var Ecran = function(){
	var that = this;

	that.rafraichie = function(map){
		
	}
	
	return that;
}
var ecran = new Ecran();

var Main = function(){
	var that = this;
	that.xMap = 0;
	that.yMap = 0;
	that.active = false;
	that.couleurCourante = ENTITE_COULEUR_VIDE;
	that.setCouleurCourante = function(entite){
		that.couleurCourante = convertieEntiteEnCouleur(entite);		
	}

	that.setPosition= function(X, Y){
		that.xMap = (X - X%DIM_BLOC) / DIM_BLOC;
		that.yMap = (Y - Y%DIM_BLOC) / DIM_BLOC;
	}
	return that;
}
var main = new Main();
var map = new Map();
function onMouseDown(event){
	
	
	//console.log("onMouseDown : " + main.active);
	var nouveauX = event.clientX - decalageX - 128 + (document.body.scrollLeft || document.documentElement.scrollLeft);
	var nouveauY = event.clientY - decalageY + (document.body.scrollTop || document.documentElement.scrollTop);
	
	//alert(ENTITE_COULEUR_MUR);
	//alert(map.getCouleur(nouveauX, nouveauY));
	main.setPosition(nouveauX, nouveauY);
	if(nbBlocsRestants > 0){		
		map.setCouleur(main.xMap, main.yMap, main.couleurCourante);
		ecran.rafraichie(map);
	}	
	main.active = true;
}

function onMouseUp(event){
	//console.log("onMouseUp : " + main.active);
	main.active = false;
}

function onMouseMove(event){
	//console.log("onMouseMove : " + main.active);
	if(nbBlocsRestants > 0 && main.active == true){		
		var nouveauX = event.clientX - decalageX - 128 + (document.body.scrollLeft || document.documentElement.scrollLeft);
		var nouveauY = event.clientY - decalageY + (document.body.scrollTop || document.documentElement.scrollTop);
		main.setPosition(nouveauX, nouveauY);
		if(map.getCouleur(main.xMap, main.yMap) != ENTITE_COULEUR_MUR){	
			map.setCouleur(main.xMap, main.yMap, main.couleurCourante);
			ecran.rafraichie(map);	
		}
	}
}

function addEvent(obj,event,fct){
  if( obj.attachEvent)
     obj.attachEvent('on' + event,fct);
  else
     obj.addEventListener(event,fct,true);
}


addEvent(document,'mousedown',onMouseDown);
addEvent(document,'mouseup',onMouseUp);
addEvent(document,'mousemove',onMouseMove);
//addEvent(document,'keydown',onKeyPress);


ecran.rafraichie(map);	
