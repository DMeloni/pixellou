
var ENTITE_HEROS = "3";
var ENTITE_TROLL = "5";
var ENTITE_PRINCESSE = "2";
var ENTITE_MUR = "1";
var ENTITE_LAVE = "4";
var ENTITE_RIEN = "0";

var DIM_BLOC = 16;

var width =  1024,//document.documentElement.clientWidth - document.documentElement.clientWidth % DIM_BLOC - DIM_BLOC, 
	height = 640,//document.documentElement.clientHeight - document.documentElement.clientHeight % DIM_BLOC - DIM_BLOC,
	c = document.getElementById('c'), 
	ctx = c.getContext('2d');			
	c.width = width;
	c.height = height;

var mapParDefaut = [
		       ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"]
		      ,["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","2","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","0","3","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","0","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","0","0","0","0","0","5","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","1","1","1","1","0","0","0","0","0","1","1"]
			  ,["0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","4","4","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","1","1","1","1","0","0","0","0","0","1","1"]
			  ,["0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","0","0","1","1"]
			  ,["1","0","1","4","4","4","4","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","0","0","1","1"]
			  ,["1","0","1","1","1","1","1","1","1","1","1","0","0","6","6","6","6","6","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0","1","1","0","0","0","0","0","0","1","1"]
			  ,["1","0","0","0","0","1","1","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0","1","1","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","0","1","1","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","0","0","0","1","1","1","1","0","0","1","1","1","1"]
			  ,["1","0","0","0","0","1","1","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","0","0","0","1","1","1","1","0","0","1","1","1","1"]
			  ,["1","0","1","1","1","1","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0","1","1","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["1","0","0","1","1","1","0","0","0","1","1","0","0","0","5","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","0","0","1","1","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["1","1","0","1","1","1","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","1","1","1","1","1","0","0","0","0","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","1","1","1","1","1","0","0","0","0","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","4","4","4","4","1","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","5","0","0","1","1","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","1","1","1","1","1","1","0","0","0","0","0","0","0","1","1","4","4","4","1","1","1","1","1","1","1","1","1","1","4","1","4","1","1","1","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","1","1","1","1","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1"]
			  ,["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","1","1","1","1","1","1","1","1","1","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","5","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","1","1","0","0","1","4","4","4","1","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","0","0","0","0","0","0","1","1","1","1","1","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","0","0","0","0","0","0","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","0","0","0","0","0","0","1","1","1","1","1","1","1","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","6","6","6","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","0","0","1","1"]
			  ,["1","1","0","0","0","0","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","1","0","0","1","1"]
			  ,["1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","5","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1"]
			  ,["1","1","1","1","1","1","1","1","1","1","1","1","1","4","4","4","4","4","4","4","1","1","1","1","1","1","1","1","4","4","4","4","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"]
			  ,["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"]
		    ];
	
// Convertie un numéro d'entite en couleur
var convertieEntiteEnCouleur = function(entite){
	if(entite == ENTITE_MUR){
		return  ENTITE_COULEUR_MUR;
	}
	if(entite == ENTITE_LAVE){
		return  ENTITE_COULEUR_LAVE;
	}	
	if(entite == ENTITE_PRINCESSE){
		return  ENTITE_COULEUR_PRINCESSE;
	}				
	if(entite == ENTITE_HEROS){
		return  ENTITE_COULEUR_HEROS;
	}		
	if(entite == ENTITE_TROLL){
		return ENTITE_COULEUR_TROLL;
	}
	return "#000000";
}
// Convertie une couleur en entite
var convertieCouleurEnEntite = function(couleur){
	if(couleur == ENTITE_COULEUR_MUR){
		return  ENTITE_MUR;
	}
	if(couleur == ENTITE_COULEUR_LAVE){
		return  ENTITE_LAVE;
	}	
	if(couleur == ENTITE_COULEUR_PRINCESSE){
		return  ENTITE_PRINCESSE;
	}				
	if(couleur == ENTITE_COULEUR_HEROS){
		return  ENTITE_HEROS;
	}		
	if(couleur == ENTITE_COULEUR_TROLL){
		return ENTITE_TROLL;
	}
	return ENTITE_RIEN;
}
// Une Map est un ensemble de case
var Map = function(){
	var that = this;
	that.representation = [];
	that.initialize = function (mapParDefaut){
		for (var j = 0; j < mapParDefaut.length ; j++) {
			for (var i = 0; i < mapParDefaut[j].length ; i++) {		
				if(typeof(that.representation[i]) == "undefined"){
					that.representation[i] = [];
				}			
				that.representation[i][j] = new Case(convertieEntiteEnCouleur(mapParDefaut[j][i]));
			}
		}
	}

	//that.representation = [];
	that.representationTexte = "";
	that.setCouleur = function(xMap, yMap, couleur){
		if(typeof(that.representation[xMap]) == 'undefined'){
			that.representation[xMap] = [];
		}		
		if(typeof(that.representation[xMap][yMap]) == 'undefined'){
			that.representation[xMap][yMap] = new Case(couleur);
		}else{
			that.representation[xMap][yMap].setCouleur(couleur);
		}
	}
	
	that.convertieEnFichierTxt = function(){
		that.representationTexte = "";
		for(var j = 0 ; j < height / 16 ; j++){
			for(var i = 0 ; i < width/16 ; i++){
				if(typeof(that.representation[i]) != 'undefined'
				&& typeof(that.representation[i][j]) != 'undefined'
				){
					that.representationTexte += that.representation[i][j].getElement();
				}else{
					that.representationTexte += ENTITE_RIEN;
				}				
			}
			that.representationTexte += "\r\n";
		}
		return that.representationTexte;
	}
		
	
	return that;
}


// Une Case est une couleur
var Case = function(couleur){
	var that = this;
	that.couleur = couleur;	
	that.setCouleur = function(couleur){
		that.couleur = couleur;
	}
	that.draw = function(xMap, yMap){
		ctx.fillStyle = that.couleur ;
		ctx.fillRect(xMap * DIM_BLOC, yMap * DIM_BLOC, DIM_BLOC, DIM_BLOC);
	};	
	
	that.getElement = function(){
		return convertieCouleurEnEntite(that.couleur);
	}
	
	return that;
}

var Ecran = function(){
	var that = this;
	
	
	that.rafraichie = function(map){
		map.representation.forEach(function(ligne, indexX){
			ligne.forEach(function(caseEnCours, indexY){
				caseEnCours.draw(indexX, indexY);
			});		
		});
	}
	
	return that;
}
var ecran = new Ecran();

var Main = function(){
	var that = this;
	that.xMap = 0;
	that.yMap = 0;
	that.active = false;
	that.couleurCourante = ENTITE_COULEUR_MUR;
	that.setCouleurCourante = function(entite){
		that.couleurCourante = convertieEntiteEnCouleur(entite);		
	}

	that.setPosition= function(X, Y){
		that.xMap = (X - X%DIM_BLOC) / DIM_BLOC;
		that.yMap = (Y - Y%DIM_BLOC) / DIM_BLOC;
	}
	return that;
}
var main = new Main();
var map = new Map();

function onMouseDown(event){
	//console.log("onMouseDown : " + main.active);
	var nouveauX = event.clientX + (document.body.scrollLeft || document.documentElement.scrollLeft);
	var nouveauY = event.clientY + (document.body.scrollTop || document.documentElement.scrollTop);
	main.setPosition(nouveauX, nouveauY);
	main.active = true;
}

function onMouseUp(event){
	//console.log("onMouseUp : " + main.active);
	main.active = false;
}

function onMouseMove(event){
	//console.log("onMouseMove : " + main.active);
	if(main.active === true){
		var nouveauX = event.clientX + (document.body.scrollLeft || document.documentElement.scrollLeft);
		var nouveauY = event.clientY + (document.body.scrollTop || document.documentElement.scrollTop);
		main.setPosition(nouveauX, nouveauY);
		map.setCouleur(main.xMap, main.yMap, main.couleurCourante);
		ecran.rafraichie(map);	
	}
}

function addEvent(obj,event,fct){
  if( obj.attachEvent)
     obj.attachEvent('on' + event,fct);
  else
     obj.addEventListener(event,fct,true);
}

function onKeyPress(event){
	//console.log("onKeyPress : " + event.keyCode);
	if(event.keyCode == '13'){
		alert("Couleur courante : " + main.couleurCourante);
	}
	
	//Touche 1 : 38 49
	if(event.keyCode == '38' || event.keyCode == '49'){
		main.setCouleurCourante(ENTITE_MUR);
		alert("Outil Mur");
	}

	//Touche 2 : 233 50
	if(event.keyCode == '233' || event.keyCode == '50'){
		main.setCouleurCourante(ENTITE_PRINCESSE);
		alert("Outil Princesse");
	}
	
	//Touche 3 : 34 51
	if(event.keyCode == '34' || event.keyCode == '51'){
		main.setCouleurCourante(ENTITE_HEROS);
		alert("Outil Heros");
	}	

	//Touche 4 : 34 51
	if(event.keyCode == '34' || event.keyCode == '51'){
		main.setCouleurCourante(ENTITE_LAVE);
		alert("Outil Lave");
	}	
	
	//Touche 5 : 40 53
	if(event.keyCode == '40' || event.keyCode == '53'){
		main.setCouleurCourante(ENTITE_TROLL);
		alert("Outil Troll");
	}	
	
	
	//Touche 6 : 45 54

	//Touche 7 : 232 55
	
}

addEvent(document,'mousedown',onMouseDown);
addEvent(document,'mouseup',onMouseUp);
addEvent(document,'mousemove',onMouseMove);
addEvent(document,'keydown',onKeyPress);

map.initialize(mapParDefaut);
ecran.rafraichie(map);	
